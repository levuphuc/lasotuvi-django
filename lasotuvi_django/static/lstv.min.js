$(document).ready(function(){const uploadLaso="/upload";const d=new Date();const thismonth=d.getMonth()+1;const today=d.getDate();const thisyear=d.getFullYear();$("#ngaysinh").val(today);$("#thangsinh").val(thismonth);$("#namsinh").val(thisyear);function dichCung(cungBanDau,soCungDich){let cungSauKhiDich=Math.floor(cungBanDau)+Math.floor(soCungDich);return cungSauKhiDich%12===0?12:cungSauKhiDich%12}$("[cung-id]").click(function(){$("[cung-id]").removeClass("xungChieu");const cungid=$(this).attr('cung-id');const cungXungChieu=dichCung(cungid,6);const cungTamHop1=dichCung(cungid,4);const cungTamHop2=dichCung(cungid,8);$(this).addClass("xungChieu");$(`[cung-id="${cungXungChieu}"]`).addClass("xungChieu");$(`[cung-id="${cungTamHop1}"]`).addClass("xungChieu");$(`[cung-id="${cungTamHop2}"]`).addClass("xungChieu")});$("#thienBan").click(function(){$("[cung-id]").removeClass("xungChieu")});function lapLaSo(laso){try{$.templates({cungDiaBan:"#cungDiaBan",vungThienBan:"#vungThienBan"});const tb=laso['thienBan'];const data=laso['thapNhiCung'];$("#thienBan").html($.templates.vungThienBan.render(tb));const cungMap=['cungTy1','cungSuu','cungDan','cungMao','cungThin','cungTy5','cungNgo','cungMui','cungThan','cungDau','cungTuat','cungHoi'];cungMap.forEach((cungId,index)=>{if(data[index+1]){$(`#${cungId}`).html($.templates.cungDiaBan.render(data[index+1]))}});new $.Zebra_Tooltips($('.tooltips'),{position:'right',max_width:300})}catch(error){baoLoi(error)}}$("#laplaso").click(function(){$("#laso").removeClass("anlaso");$("#urlLaso").val("");$.ajax({url:'api',type:'GET',dataType:'json',data:$('form#lstv').serialize(),success:lapLaSo,error:baoLoi})});function baoLoi(data){$("#laso").addClass("anlaso");alert("Có lỗi, không thể lấy được lá số.")}const downloadBtn=document.getElementById('downloadBtn');if(downloadBtn){downloadBtn.addEventListener('click',function(){const target=document.getElementById('laso');html2canvas(target,{scale:2,useCORS:true}).then(canvas=>{const link=document.createElement('a');link.download='la_so_tu_vi.png';link.href=canvas.toDataURL();link.click()})})}const uploadBtn=$("#uploadLaso");if(uploadBtn.length){uploadBtn.click(function(){if($("#laso").is(':hidden')){alert("Hãy an lá số trước khi upload!");return false}html2canvas(document.getElementById("laso"),{background:'#FFFFFF',onrendered:function(canvas){const canvasData=canvas.toDataURL("image/jpeg").replace("image/jpeg","image/octet-stream");$.ajax({url:uploadLaso,type:"POST",data:{image:canvasData,hoten:$("#hoten").val(),ngaysinh:$("#ngaysinh").val(),thangsinh:$("#thangsinh").val(),namsinh:$("#namsinh").val()},dataType:"json",success:function(response){if(response.error===false){$("#urlLaso").val(response.message);alert("Upload thành công.")}else{alert("Có lỗi, không lưu được lá số trên server.")}},error:function(){alert("Có lỗi, không lưu được lá số trên server.")}})}})})}})